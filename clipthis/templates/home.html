{% extends 'base.html' %}
{% block title %}Clip This ‚Äî Turn Live Moments into Shareable Highlights{% endblock %}
{% block content %}
  {% if not request.user.is_authenticated %}
    <section class="p-4 p-md-5 mb-4 rounded-3 border" style="background: linear-gradient(135deg, rgba(124,58,237,.08), rgba(6,182,212,.08));">
      <div class="container-fluid py-2">
        <h1 class="display-6 fw-bold mb-2 text-body">The Easiest Way to Find Clippers for Your Stream.</h1>
        <p class="lead text-body-secondary mb-3">Clip This connects streamers with the community that loves them ‚Äî crowdsource the best moments, vote them up, and showcase highlights together.</p>
        <div class="d-flex flex-wrap gap-2 mb-2">
          <a class="btn btn-primary" href="/accounts/login/"><i class="fa-solid fa-bolt me-1"></i> Get started with Google</a>
          <a class="btn btn-outline-secondary" href="/faq/"><i class="fa-solid fa-circle-question me-1"></i> Learn how it works</a>
        </div>
        <div class="text-body-secondary small">Free to start ‚Ä¢ No credit card ‚Ä¢ Keep tips outside the app</div>
      </div>
    </section>
  {% else %}
    <div class="alert alert-success" role="alert">
      <i class="fa-solid fa-handshake me-1"></i>Welcome back. Manage your requests on <a href="/streams/" class="alert-link">My Streams</a>.
      <span class="ms-2">Need details? See our <a href="/faq/" class="alert-link">Q&amp;A / FAQ</a>.</span>
    </div>
  {% endif %}

  <section class="mt-4">
    <div class="card shadow-sm">
      <div class="card-body d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
        <div>
          <div class="h5 m-0">Clip This GPT</div>
          <div class="text-body-secondary small">Your Clipping Coach & Streaming Assistant for ClipThis.xyz</div>
        </div>
        <div>
          <a class="btn btn-outline-primary" href="https://chatgpt.com/g/g-68bf447caca48191bd3b1c6a1ae8c422-clipthis-gpt" target="_blank" rel="noopener">
            <i class="fa-solid fa-robot me-1"></i> Open ClipThis GPT
          </a>
        </div>
      </div>
    </div>
  </section>

  {% if not request.user.is_authenticated %}
  <section class="mt-4">
    <div class="row g-3">
      <div class="col-12 col-lg-7">
        <div class="card h-100">
          <div class="card-body">
            <h2 class="h5 mb-3"><i class="fa-solid fa-route me-1"></i>How it works</h2>
            <ol class="text-body-secondary small m-0" style="line-height:1.7;">
              <li><strong>Post your stream</strong> ‚Äî Add a YouTube, Twitch, Kick, or pump.fun link with notes and a tip amount.</li>
              <li><strong>Clippers contribute</strong> ‚Äî Your community submits clip links beneath your stream request.</li>
              <li><strong>Vote together</strong> ‚Äî Thumbs up/down bubbles up the best highlights.</li>
              <li><strong>Tip outside the app</strong> ‚Äî PayPal, Cash App, crypto, and more via profile handles.</li>
            </ol>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-5">
        <div class="card h-100">
          <div class="card-body">
            <h2 class="h5 mb-3"><i class="fa-solid fa-star me-1"></i>Why creators use Clip This</h2>
            <ul class="text-body-secondary small m-0" style="line-height:1.7;">
              <li><strong>More eyes, better clips</strong> ‚Äî crowdsource standout moments.</li>
              <li><strong>Own your audience</strong> ‚Äî tips handled outside the app.</li>
              <li><strong>Fast to start</strong> ‚Äî sign in with Google, post in seconds.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="alert alert-info mt-3 mb-0" role="alert">
      <i class="fa-solid fa-rocket me-1"></i>More is coming soon: notifications, leaderboards, smarter discovery, and team workflows.
    </div>
  </section>
  {% endif %}

  {% if request.user.is_authenticated %}
    <form method="get" class="border rounded p-3 mb-3 bg-body-tertiary">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
        <div class="fw-semibold">Filter by tip amount</div>
        <div class="d-flex align-items-center gap-2">
          <span class="badge text-bg-secondary" id="min_badge">${{ filter_min_tip|floatformat:2 }}</span>
          <span>to</span>
          <span class="badge text-bg-secondary" id="max_badge">${{ filter_max_tip|floatformat:2 }}</span>
        </div>
      </div>
      <div class="range-wrap" data-db-min="{{ db_min_tip|default:0 }}" data-db-max="{{ db_max_tip|default:0 }}">
        <div class="range-track" id="range_track"><div class="range-fill" id="range_fill"></div></div>
        <div class="range-inputs">
          <input type="range" name="min" id="filter_min" class="form-range" min="{{ db_min_tip }}" max="{{ db_max_tip }}" step="0.01" value="{{ filter_min_tip }}" aria-label="Minimum tip">
          <input type="range" name="max" id="filter_max" class="form-range" min="{{ db_min_tip }}" max="{{ db_max_tip }}" step="0.01" value="{{ filter_max_tip }}" aria-label="Maximum tip">
        </div>
      </div>
      <div class="d-flex justify-content-between text-body-secondary small mt-2">
        <div>DB range: ${% if db_min_tip %}{{ db_min_tip|floatformat:2 }}{% else %}0.00{% endif %} ‚Äì ${% if db_max_tip %}{{ db_max_tip|floatformat:2 }}{% else %}0.00{% endif %}</div>
        <button class="btn btn-primary btn-sm" type="submit"><i class="fa-solid fa-filter me-1"></i>Apply</button>
      </div>
    </form>

    <h2 class="h4 mt-4"><i class="fa-solid fa-bolt me-1"></i>Active Stream Requests</h2>
    {% if active_links %}
      <ul class="list-group">
        {% for link in active_links %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between align-items-start">
              <div class="d-flex gap-3">
                {% if link.yt_thumbnail %}
                  <a href="{% url 'streams:public_detail' link.pk %}"><img src="{{ link.yt_thumbnail }}" alt="Thumbnail" style="width:120px;height:auto;border-radius:6px;" loading="lazy" /></a>
                {% endif %}
                <div>
                  <a class="fw-semibold" href="{% url 'streams:public_detail' link.pk %}">
                    {% if link.yt_title %}{{ link.yt_title }}{% else %}<i class="fa-solid fa-up-right-from-square me-1"></i>{{ link.url }}{% endif %}
                  </a>
                  <div class="text-muted small">
                    {% if link.yt_channel %}{{ link.yt_channel }} ‚Ä¢ {% endif %}
                    by {{ link.owner.get_full_name|default:link.owner.username }} ¬∑ <i class="fa-solid fa-dollar-sign me-1"></i>${{ link.tip_amount }} ¬∑ <i class="fa-solid fa-film me-1"></i>{{ link.clip_count|default:link.clips.count }}
                  </div>
                  {% if link.notes %}<div class="text-muted small mt-1">{{ link.notes }}</div>{% endif %}
                </div>
              </div>
              <div>
                <div class="d-flex align-items-center gap-2">
                  <form method="post" action="{% url 'streams:rate_stream' link.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="value" value="1" />
                    <button class="btn btn-sm btn-outline-success" type="submit">üëç {{ link.up_count|default:0 }}</button>
                  </form>
                  <form method="post" action="{% url 'streams:rate_stream' link.pk %}">
                    {% csrf_token %}
                    <input type="hidden" name="value" value="-1" />
                    <button class="btn btn-sm btn-outline-danger" type="submit">üëé {{ link.down_count|default:0 }}</button>
                  </form>
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'streams:public_detail' link.pk %}"><i class="fa-solid fa-eye me-1"></i>View details</a>
                </div>
              </div>
            </div>
          </li>
        {% endfor %}
      </ul>

      {% if is_paginated %}
        <nav aria-label="Active streams pagination" class="mt-3">
          <ul class="pagination pagination-sm">
            {% if page_obj.has_previous %}
              <li class="page-item"><a class="page-link" href="?min={{ filter_min_tip }}&max={{ filter_max_tip }}&page={{ page_obj.previous_page_number }}">Prev</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Prev</span></li>
            {% endif %}

            {% for num in paginator.page_range %}
              {% if num == page_obj.number %}
                <li class="page-item active" aria-current="page"><span class="page-link">{{ num }}</span></li>
              {% else %}
                <li class="page-item"><a class="page-link" href="?min={{ filter_min_tip }}&max={{ filter_max_tip }}&page={{ num }}">{{ num }}</a></li>
              {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
              <li class="page-item"><a class="page-link" href="?min={{ filter_min_tip }}&max={{ filter_max_tip }}&page={{ page_obj.next_page_number }}">Next</a></li>
            {% else %}
              <li class="page-item disabled"><span class="page-link">Next</span></li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    {% else %}
      <p class="text-muted">No active requests yet.</p>
    {% endif %}
  {% else %}
    <div class="row g-4 mt-2">
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <h3 class="h5"><i class="fa-solid fa-people-group me-1"></i>What is Clip This?</h3>
            <p>Clip This connects streamers with community clippers. Streamers post stream links with notes and optional tips; clippers submit highlight clips to those streams.</p>
            <ul class="text-body-secondary small mb-0">
              <li>Discover, create, and share great stream highlights.</li>
              <li>Supported links: YouTube, Twitch, Kick.</li>
              <li>Simple thumbs up/down voting for streams and clips.</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <h3 class="h5"><i class="fa-solid fa-circle-question me-1"></i>How to get started</h3>
            <ol class="text-body-secondary small">
              <li>Sign in with Google.</li>
              <li>Choose a plan (Free, Plus, Premium).</li>
              <li>Create stream links or browse and submit clips.</li>
            </ol>
            <a class="btn btn-primary btn-sm" href="/accounts/signup/"><i class="fa-solid fa-user-plus me-1"></i>Create an account</a>
            <a class="btn btn-outline-secondary btn-sm ms-2" href="/faq/"><i class="fa-solid fa-circle-question me-1"></i>Read Q&amp;A / FAQ</a>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

{% block extra_scripts %}
  {{ block.super }}
  {% if request.user.is_authenticated %}
  <script>
    (function(){
      var minEl = document.getElementById('filter_min');
      var maxEl = document.getElementById('filter_max');
      var minBadge = document.getElementById('min_badge');
      var maxBadge = document.getElementById('max_badge');
      var wrap = document.querySelector('.range-wrap');
      var fill = document.getElementById('range_fill');
      var track = document.getElementById('range_track');
      if(!minEl || !maxEl) return;
      var dbMin = parseFloat(wrap?.getAttribute('data-db-min') || '0');
      var dbMax = parseFloat(wrap?.getAttribute('data-db-max') || '0');
      var span = Math.max(dbMax - dbMin, 0.0001);
      function clamp(){
        var minv = parseFloat(minEl.value);
        var maxv = parseFloat(maxEl.value);
        if(minv > maxv){ maxEl.value = minv; }
        if(minBadge) minBadge.textContent = '$' + parseFloat(minEl.value).toFixed(2);
        if(maxBadge) maxBadge.textContent = '$' + parseFloat(maxEl.value).toFixed(2);
        if(fill && track){
          var w = track.getBoundingClientRect().width;
          var leftPx = ((parseFloat(minEl.value) - dbMin) / span) * w;
          var rightPx = ((parseFloat(maxEl.value) - dbMin) / span) * w;
          leftPx = Math.min(Math.max(leftPx, 0), w);
          rightPx = Math.min(Math.max(rightPx, 0), w);
          fill.style.left = leftPx + 'px';
          fill.style.width = Math.max(rightPx - leftPx, 0) + 'px';
        }
      }
      minEl.addEventListener('input', clamp);
      maxEl.addEventListener('input', clamp);
      window.addEventListener('resize', clamp);
      clamp();
    })();
  </script>
  {% endif %}
{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <style>
    .range-track{ position: relative; width:100%; height: 8px; border-radius: 6px; background: var(--bs-border-color); }
    .range-fill{ position:absolute; height:8px; border-radius:6px; background: linear-gradient(90deg, #7c3aed, #06b6d4); left:0; width:0; }
    .range-inputs{ position: relative; height: 0; }
    .range-inputs input.form-range{ position: absolute; left:0; width:100%; top:-12px; background: transparent; accent-color: #7c3aed; }
    /* Hide native track to rely on custom track */
    .range-inputs input.form-range::-webkit-slider-runnable-track{ background: transparent; }
    .range-inputs input.form-range::-moz-range-track{ background: transparent; }
  </style>
{% endblock %}
{% endblock %}
